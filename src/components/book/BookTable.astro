---
import type { Book } from "@/data/books";

interface Props {
	books: Book[];
}

const { books } = Astro.props;

const getSlug = (title: string) =>
	title
		.toLowerCase()
		.replace(/[^\w\s-]/g, "")
		.replace(/[\s_-]+/g, "-")
		.replace(/^-+|-+$/g, "");

const getCover = (book: Book) => {
	if (book.cover) return book.cover;
	if (book.isbn) return `https://covers.openlibrary.org/b/isbn/${book.isbn}-L.jpg`;
	return "https://placehold.co/100x150?text=No+Cover";
};

const statusMap: Record<string, string> = {
	reading: "Reading",
	read: "Read",
	"want-to-read": "To Read",
	wishlist: "Wishlist",
};

// Get unique tags for filter
const allTags = Array.from(new Set(books.flatMap((b) => b.tags || []))).sort();
---

<div class="space-y-8">
	{/* Filters */}
	<div class="sticky top-0 z-40 flex flex-wrap gap-2 bg-global-bg/95 py-4 backdrop-blur transition-all">
		<button
			data-value="all"
			class="filter-btn active bg-textColor/5 hover:bg-textColor/10 text-textColor/60 aria-pressed:text-accent aria-pressed:bg-accent/10 rounded-full px-3 py-1 text-xs font-medium transition-colors"
			aria-pressed="true">All</button
		>
		{
			allTags.map((tag) => (
				<button
					data-value={tag}
					class="filter-btn bg-textColor/5 hover:bg-textColor/10 text-textColor/60 aria-pressed:text-accent aria-pressed:bg-accent/10 rounded-full px-3 py-1 text-xs font-medium transition-colors"
					aria-pressed="false"
				>
					{tag}
				</button>
			))
		}
	</div>

	{/* Grid View */}
	<div
		id="grid-view"
		class="grid grid-cols-2 gap-x-8 gap-y-12 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5"
	>
		{
			books.map((book) => (
				<div
					class="book-grid-item group flex flex-col gap-2"
					data-tags={book.tags?.join(",") || ""}
				>
					<button
						type="button"
						class="book-trigger aspect-[2/3] w-full max-w-[160px] overflow-hidden rounded-md bg-textColor/5 shadow-sm hover:shadow-md border border-textColor/10 transition-all hover:scale-105 cursor-pointer block relative group"
						data-title={book.title}
						data-author={book.author}
						data-cover={getCover(book)}
						data-rating={book.rating}
						data-desc={book.description}
						data-rec={book.recommendation}
						aria-label={`View details for ${book.title}`}
					>
						<img
							src={getCover(book)}
							alt={`Cover of ${book.title}`}
							class="h-full w-full object-cover"
							loading="lazy"
						/>
						{book.recommendation && (
							<div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center p-4 text-center backdrop-blur-[2px]">
								<p class="text-white text-xs font-medium italic line-clamp-6">"{book.recommendation}"</p>
							</div>
						)}
					</button>
					{book.rating && (
						<div class="flex items-center gap-1" title={`Rating: ${book.rating}/5`}>
							{Array.from({ length: 5 }).map((_, i) => {
								const isFull = i < Math.floor(book.rating || 0);
								const isHalf = !isFull && i < (book.rating || 0);
								const isEmpty = !isFull && !isHalf;

								return (
									<svg
										aria-hidden="true"
										class="h-2.5 w-2.5"
										xmlns="http://www.w3.org/2000/svg"
										viewBox="0 0 24 24"
										stroke-width="2"
									>
										{isFull && (
											<circle cx="12" cy="12" r="10" class="fill-accent text-accent" stroke="currentColor" />
										)}
										{isHalf && (
											<>
												<circle cx="12" cy="12" r="10" class="fill-transparent text-textColor/10" stroke="currentColor" />
												<path d="M12 2 A10 10 0 0 0 12 22 Z" class="fill-accent text-accent" stroke="none" />
											</>
										)}
										{isEmpty && (
											<circle cx="12" cy="12" r="10" class="fill-transparent text-textColor/10" stroke="currentColor" />
										)}
									</svg>
								);
							})}
						</div>
					)}
				</div>
			))
		}
	</div>

	<div id="no-results" class="text-textColor/50 hidden py-8 text-center italic">
		No books match your filters.
	</div>

	{/* Book Detail Modal */}
	<dialog
		id="book-modal"
		class="bg-global-bg text-textColor backdrop:bg-black/50 backdrop:backdrop-blur-sm open:animate-fade-in m-auto w-full max-w-2xl rounded-xl border border-textColor/10 p-0 shadow-2xl"
	>
		<div class="relative flex flex-col md:flex-row">
			<button
				id="close-modal"
				class="text-textColor/60 hover:text-textColor hover:bg-textColor/5 absolute top-2 right-2 z-10 rounded-full p-2 transition-colors cursor-pointer"
				aria-label="Close modal"
			>
				<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"
					></path>
				</svg>
			</button>

			<div class="bg-textColor/5 md:w-1/3 flex items-center justify-center p-4 md:p-0">
				<img
					id="modal-cover"
					src=""
					alt=""
					class="h-64 w-full object-contain md:h-full"
				/>
			</div>
			
			<div class="flex flex-col p-6 md:w-2/3 gap-4 md:border-l md:border-textColor/10">
				<div>
					<h2 id="modal-title" class="text-xl font-bold leading-tight text-pretty pr-8"></h2>
					<p id="modal-author" class="text-textColor/60 text-sm font-medium mt-1"></p>
				</div>

				<div id="modal-rating" class="flex items-center gap-1">
					{/* Rating stars populated by JS */}
				</div>

				<div class="space-y-4 text-sm">
					<div>
						<h3 class="font-medium text-xs uppercase tracking-wider text-textColor/40 mb-1">About</h3>
						<p id="modal-desc" class="text-textColor/80 leading-relaxed text-pretty"></p>
					</div>

					<div id="modal-rec-container" class="hidden">
						<h3 class="font-medium text-xs uppercase tracking-wider text-textColor/40 mb-1">My Thoughts</h3>
						<p id="modal-rec" class="text-accent italic leading-relaxed text-pretty"></p>
					</div>
				</div>
			</div>
		</div>
	</dialog>
</div>

<script>
	const filterBtns = document.querySelectorAll(".filter-btn");
	const gridItems = document.querySelectorAll(".book-grid-item");
	const noResults = document.getElementById("no-results");
	const modal = document.getElementById("book-modal") as HTMLDialogElement;
	const closeModalBtn = document.getElementById("close-modal");
	const bookTriggers = document.querySelectorAll(".book-trigger");

	// Modal Elements
	const modalCover = document.getElementById("modal-cover") as HTMLImageElement;
	const modalTitle = document.getElementById("modal-title");
	const modalAuthor = document.getElementById("modal-author");
	const modalRating = document.getElementById("modal-rating");
	const modalDesc = document.getElementById("modal-desc");
	const modalRec = document.getElementById("modal-rec");
	const modalRecContainer = document.getElementById("modal-rec-container");

	// Filter Logic
	let currentTag = "all";

	function filterBooks() {
		let visibleCount = 0;

		gridItems.forEach((item) => {
			const itemTags = ((item as HTMLElement).dataset.tags || "").split(",");
			const tagMatch = currentTag === "all" || itemTags.includes(currentTag);

			if (tagMatch) {
				(item as HTMLElement).style.display = "";
				visibleCount++;
			} else {
				(item as HTMLElement).style.display = "none";
			}
		});

		if (noResults) {
			noResults.style.display = visibleCount === 0 ? "block" : "none";
		}
	}

	filterBtns.forEach((btn) => {
		btn.addEventListener("click", () => {
			const value = (btn as HTMLElement).dataset.value;
			if (!value) return;
			filterBtns.forEach((b) => b.setAttribute("aria-pressed", "false"));
			btn.setAttribute("aria-pressed", "true");
			currentTag = value;
			filterBooks();
		});
	});

	// Modal Logic
	bookTriggers.forEach((trigger) => {
		trigger.addEventListener("click", () => {
			const data = (trigger as HTMLElement).dataset;
			
			if (modalCover) modalCover.src = data.cover || "";
			if (modalTitle) modalTitle.textContent = data.title || "";
			if (modalAuthor) modalAuthor.textContent = data.author || "";
			if (modalDesc) modalDesc.textContent = data.desc || "No description available.";
			
			// Recommendation
			if (data.rec) {
				if (modalRec) modalRec.textContent = data.rec;
				modalRecContainer?.classList.remove("hidden");
			} else {
				modalRecContainer?.classList.add("hidden");
			}

			// Rating
			if (modalRating) {
				modalRating.innerHTML = "";
				const rating = parseFloat(data.rating || "0");
				for (let i = 0; i < 5; i++) {
					const dot = document.createElementNS("http://www.w3.org/2000/svg", "svg");
					dot.setAttribute("viewBox", "0 0 24 24");
					dot.setAttribute("stroke-width", "2");
					dot.setAttribute("class", "h-3 w-3");

					if (i < Math.floor(rating)) {
						dot.setAttribute("class", "h-3 w-3 fill-accent text-accent");
						dot.setAttribute("stroke", "currentColor");
						dot.innerHTML = '<circle cx="12" cy="12" r="10" />';
					} else if (i < rating) {
						// Half star
						dot.innerHTML = `
							<circle cx="12" cy="12" r="10" class="fill-transparent text-textColor/10" stroke="currentColor" />
							<path d="M12 2 A10 10 0 0 0 12 22 Z" class="fill-accent text-accent" stroke="none" />
						`;
					} else {
						dot.setAttribute("class", "h-3 w-3 fill-transparent text-textColor/10");
						dot.setAttribute("stroke", "currentColor");
						dot.innerHTML = '<circle cx="12" cy="12" r="10" />';
					}
					modalRating.appendChild(dot);
				}
			}

			modal.showModal();
		});
	});

	closeModalBtn?.addEventListener("click", () => modal.close());

	modal.addEventListener("click", (e) => {
		const dialogDimensions = modal.getBoundingClientRect();
		if (
			e.clientX < dialogDimensions.left ||
			e.clientX > dialogDimensions.right ||
			e.clientY < dialogDimensions.top ||
			e.clientY > dialogDimensions.bottom
		) {
			modal.close();
		}
	});
</script>
