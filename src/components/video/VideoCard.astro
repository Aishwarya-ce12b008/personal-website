---
interface Props {
	title: string;
	youtubeUrl: string;
	channel?: string;
	duration?: string;
	takeaway?: string;
	tags?: string[];
	index?: number;
}

const { title, youtubeUrl, channel, duration, takeaway, tags = [], index = 0 } = Astro.props;

// Extract video ID from various YouTube URL formats
function getYouTubeId(url: string): string | null {
	const patterns = [
		/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
		/youtube\.com\/shorts\/([^&\n?#]+)/,
	];
	for (const pattern of patterns) {
		const match = url.match(pattern);
		if (match) return match[1];
	}
	return null;
}

const videoId = getYouTubeId(youtubeUrl);
const thumbnailUrl = videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : null;
const embedUrl = videoId ? `https://www.youtube.com/embed/${videoId}` : null;

// Staggered animation delay
const delay = (index % 6) * 0.08;
---

<div
	class="video-card group relative"
	style={`--animation-delay: ${delay}s`}
	data-video-id={videoId}
>
	<!-- Thumbnail with overlay -->
	<div class="thumbnail-wrapper relative aspect-video overflow-hidden rounded-lg cursor-pointer" data-embed-url={embedUrl}>
		{thumbnailUrl && (
			<img
				src={thumbnailUrl}
				alt={title}
				class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
				loading="lazy"
			/>
		)}
		
		<!-- Gradient overlay -->
		<div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-60 transition-opacity duration-300 group-hover:opacity-80" />
		
		<!-- Play button -->
		<div class="absolute inset-0 flex items-center justify-center">
			<div class="play-button flex h-16 w-16 items-center justify-center rounded-full bg-white/10 backdrop-blur-sm border border-white/20 transition-all duration-300 group-hover:scale-110 group-hover:bg-red-600/90 group-hover:border-red-500">
				<svg class="ml-1 h-6 w-6 text-white" fill="currentColor" viewBox="0 0 24 24">
					<path d="M8 5v14l11-7z" />
				</svg>
			</div>
		</div>

		</div>

	<!-- Content -->
	<div class="mt-3 space-y-1.5">
		<h3 class="font-medium text-accent-2 leading-snug line-clamp-2 group-hover:text-accent transition-colors">
			{title}
		</h3>
		
		<!-- Meta: channel & duration -->
		{(channel || duration) && (
			<div class="flex items-center gap-2 text-xs text-global-text/50">
				{channel && <span>{channel}</span>}
				{channel && duration && <span>Â·</span>}
				{duration && <span class="tabular-nums">{duration}</span>}
			</div>
		)}
		
		{takeaway && (
			<p class="text-global-text/60 text-sm line-clamp-2 leading-relaxed pt-1">
				{takeaway}
			</p>
		)}

		{tags.length > 0 && (
			<div class="flex flex-wrap gap-1.5 pt-1">
				{tags.slice(0, 3).map((tag) => (
					<span class="text-xs text-global-text/40 before:content-['#']">
						{tag}
					</span>
				))}
			</div>
		)}
	</div>
</div>

<!-- Video Modal (shared, only one needed) -->
<dialog id="video-modal" class="video-modal bg-transparent backdrop:bg-black/90 backdrop:backdrop-blur-sm p-0 max-w-5xl w-full">
	<div class="relative">
		<button class="close-modal absolute -top-10 right-0 text-white/80 hover:text-white transition-colors">
			<svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
			</svg>
		</button>
		<div class="aspect-video w-full rounded-lg overflow-hidden bg-black">
			<iframe
				id="video-iframe"
				class="h-full w-full"
				allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
				allowfullscreen
			></iframe>
		</div>
	</div>
</dialog>

<style>
	.video-card {
		animation: fadeSlideUp 0.5s ease-out forwards;
		animation-delay: var(--animation-delay);
		opacity: 0;
	}

	@keyframes fadeSlideUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.video-modal::backdrop {
		animation: fadeIn 0.2s ease-out;
	}

	.video-modal[open] {
		animation: scaleIn 0.2s ease-out;
	}

	@keyframes fadeIn {
		from { opacity: 0; }
		to { opacity: 1; }
	}

	@keyframes scaleIn {
		from {
			opacity: 0;
			transform: scale(0.95);
		}
		to {
			opacity: 1;
			transform: scale(1);
		}
	}

	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>

<script>
	function initVideoCards() {
		const modal = document.getElementById('video-modal') as HTMLDialogElement;
		const iframe = document.getElementById('video-iframe') as HTMLIFrameElement;
		const thumbnails = document.querySelectorAll('.thumbnail-wrapper');
		const closeBtn = modal?.querySelector('.close-modal');

		thumbnails.forEach((thumb) => {
			thumb.addEventListener('click', () => {
				const embedUrl = thumb.getAttribute('data-embed-url');
				if (embedUrl && iframe && modal) {
					iframe.src = embedUrl + '?autoplay=1';
					modal.showModal();
				}
			});
		});

		closeBtn?.addEventListener('click', () => {
			if (iframe) iframe.src = '';
			modal?.close();
		});

		modal?.addEventListener('click', (e) => {
			if (e.target === modal) {
				if (iframe) iframe.src = '';
				modal.close();
			}
		});

		// Close on escape
		modal?.addEventListener('close', () => {
			if (iframe) iframe.src = '';
		});
	}

	// Run on initial load
	initVideoCards();

	// Re-run on Astro page transitions
	document.addEventListener('astro:after-swap', initVideoCards);
</script>

